# CAIA Shared Session Architecture

## Overview

Three independent bots (Claude, Codex, OpenCode) share common infrastructure from `slack/` while maintaining complete isolation. Each bot has its own session file, conversation tracker, and can operate in parallel with other bots. Within a single bot, concurrent queries to the same conversation are blocked.

---

## 1. Directory Structure

```
slack/src/
├── index.ts                      # Barrel export
├── types.ts                      # Existing: IAgent, AgentCapabilities, IModelProvider
├── errors.ts                     # Existing: SlackBotError, toUserMessage
├── retry.ts                      # Existing: withSlackRetry, withRetry
├── file-handler.ts               # Existing: processSlackFiles
├── markdown-png.ts               # Existing: markdownToPng
│
├── session/
│   ├── index.ts                  # Barrel export for session module
│   ├── types.ts                  # Base session interfaces
│   ├── conversation-key.ts       # makeConversationKey, parseConversationKey
│   ├── conversation-tracker.ts   # In-memory busy state + active contexts
│   └── base-session-manager.ts   # Abstract base with mutex + persistence
│
├── activity/
│   ├── index.ts                  # Barrel export
│   ├── types.ts                  # ActivityEntry, ActivityType
│   ├── activity-manager.ts       # Rolling window logic, entry formatting
│   ├── activity-blocks.ts        # Shared Block Kit builders for activity
│   └── activity-thread.ts        # Thread posting, batch updates
│
├── ui/
│   ├── index.ts                  # Barrel export
│   ├── status-blocks.ts          # Status panel blocks (model, tokens, session)
│   ├── fork-blocks.ts            # Fork Here button, fork modal
│   ├── abort-blocks.ts           # Abort button, confirmation modal
│   └── emoji-reactions.ts        # Processing emoji helpers
│
└── notifications/
    ├── index.ts                  # Barrel export
    └── dm-notifications.ts       # DM notification on completion
```

---

## 2. Session Management

### 2.1 Session Files (Per-Agent)

```
./claude-sessions.json   # Claude bot sessions
./codex-sessions.json    # Codex bot sessions  
./opencode-sessions.json # OpenCode bot sessions
```

Each file has identical structure but independent data:

```typescript
{
  "channels": {
    "C_PROJECT_ALPHA": {
      // Base session fields (shared interface)
      "workingDir": "/projects/alpha",
      "createdAt": 1706000000000,
      "lastActiveAt": 1706001000000,
      "pathConfigured": true,
      "configuredPath": "/projects/alpha",
      "configuredBy": "U_USER1",
      "configuredAt": 1706000000000,
      "updateRateSeconds": 3,
      "threadCharLimit": 500,
      
      // Agent-specific session ID
      "sessionId": "ses_abc123",        // Claude: SDK session ID
      // OR "threadId": "thread_xyz",   // Codex: Codex thread ID
      
      // Agent-specific fields
      "mode": "default",                // Claude: PermissionMode
      // OR "approvalPolicy": "never",  // Codex: ApprovalPolicy
      
      "model": "claude-sonnet-4-20250514",
      "lastUsage": { ... },
      
      // Fork point tracking (REQUIRED - shared interface)
      "messageMap": {
        "111.111": {
          "pointId": "msg_abc",         // SDK message ID (Claude) or turn ID (Codex)
          "sessionId": "ses_abc123",
          "type": "user"
        },
        "111.222": {
          "pointId": "msg_def", 
          "sessionId": "ses_abc123",
          "type": "assistant",
          "parentSlackTs": "111.111"
        }
      },
      
      // Thread sessions
      "threads": {
        "123.456": {
          "sessionId": "ses_forked_789",
          "forkedFrom": "ses_abc123",
          "forkPointId": "msg_def",      // Point-in-time fork reference
          "workingDir": "/projects/alpha",
          // ... inherits other fields
        }
      }
    }
  }
}
```

### 2.2 Base Session Interface

```typescript
// slack/src/session/types.ts

interface BaseSession {
  // Working directory
  workingDir: string;
  
  // Timestamps
  createdAt: number;
  lastActiveAt: number;
  
  // Path configuration (immutable once set)
  pathConfigured: boolean;
  configuredPath: string | null;
  configuredBy: string | null;
  configuredAt: number | null;
  
  // UI configuration
  updateRateSeconds?: number;   // 1-10, default 3
  threadCharLimit?: number;     // 100-36000, default 500
}

interface BaseThreadSession extends BaseSession {
  forkedFrom: string | null;    // Parent session ID
  forkPointId?: string;         // Point-in-time fork reference
}

// Fork point tracking (REQUIRED for all agents)
interface MessageMapping {
  pointId: string;              // Agent-specific: SDK msg ID, turn ID, etc.
  sessionId: string;            // Session this message belongs to
  type: 'user' | 'assistant';
  parentSlackTs?: string;       // Links response to triggering message
}

interface ForkPoint {
  pointId: string;
  sessionId: string;
}
```

### 2.3 Conversation Tracker (In-Memory)

```typescript
// slack/src/session/conversation-tracker.ts

interface ActiveContext {
  conversationKey: string;
  statusMsgTs: string;          // Activity message being updated
  originalTs: string;           // User's message (for emoji reactions)
  startTime: number;
  userId?: string;
  query?: string;               // For DM preview
}

class ConversationTracker<T extends ActiveContext> {
  private busy: Set<string>;
  private contexts: Map<string, T>;
  
  isBusy(key: string): boolean;
  startProcessing(key: string, ctx: T): boolean;  // Returns false if already busy
  stopProcessing(key: string): void;
  getContext(key: string): T | undefined;
  updateContext(key: string, updates: Partial<T>): void;
}
```

### 2.4 What Gets Persisted vs In-Memory

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AGENT INSTANCE (e.g., Claude)                        │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ IN-MEMORY (ConversationTracker)                                      │    │
│  │                                                                       │    │
│  │ busyConversations: Set {                                             │    │
│  │   "C_ALPHA",           ← #project-alpha main channel is processing   │    │
│  │   "C_BETA_123.456"     ← #project-beta thread is processing          │    │
│  │ }                                                                     │    │
│  │                                                                       │    │
│  │ activeContexts: Map {                                                │    │
│  │   "C_ALPHA" → { statusMsgTs: "111.222", originalTs: "111.111", ... } │    │
│  │   "C_BETA_123.456" → { statusMsgTs: "789.012", ... }                 │    │
│  │ }                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ PERSISTED (claude-sessions.json)                                     │    │
│  │                                                                       │    │
│  │ - sessionId, workingDir, mode, model                                 │    │
│  │ - messageMap (for fork point lookup)                                 │    │
│  │ - lastUsage, pathConfigured, etc.                                    │    │
│  │ - Thread sessions                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

| Data | Storage | Why |
|------|---------|-----|
| `busyConversations` | In-memory | Transient state, cleared on restart is OK |
| `activeContexts` | In-memory | Status message refs, cleared on restart is OK |
| `sessionId` | Persisted | Must survive restart to continue conversations |
| `messageMap` | Persisted | Must survive restart for fork-point lookup |
| `workingDir`, `mode`, etc. | Persisted | Configuration must survive |

---

## 3. Activity System

### 3.1 Activity Entry Types

```typescript
// slack/src/activity/types.ts

type ActivityType = 
  | 'starting'      // "Analyzing request..."
  | 'thinking'      // Extended thinking block
  | 'tool_start'    // Tool execution started
  | 'tool_complete' // Tool execution finished
  | 'generating'    // Text generation in progress
  | 'error'         // Error occurred
  | 'aborted'       // User aborted
  | 'complete';     // Turn finished

interface ActivityEntry {
  timestamp: number;
  type: ActivityType;
  
  // Tool info
  tool?: string;
  toolInput?: Record<string, unknown>;
  toolOutput?: string;
  toolIsError?: boolean;
  durationMs?: number;
  
  // Thinking info
  thinkingContent?: string;
  thinkingTruncated?: string;   // First N chars for display
  
  // Thread message linking
  threadMessageTs?: string;
  threadMessageLink?: string;   // Permalink for [view] button
  
  // Result metrics
  lineCount?: number;           // For Read/Write
  matchCount?: number;          // For Grep/Glob
}
```

### 3.2 Rolling Activity Window

**Display format** (matches ccslack):

```
┌─────────────────────────────────────────────────────────────┐
│ ◐ Processing...                                              │
│                                                              │
│ :gear: Starting...                                           │
│ :thought_balloon: *Thinking* (2.3s)                    [view]│
│ :mag: Grep "session" in *.ts → 47 matches              [view]│
│ :page_facing_up: Read slack/src/types.ts (42 lines)    [view]│
│ :pencil2: Edit codex/src/streaming.ts [in progress]          │
├──────────────────────────────────────────────────────────────┤
│ Session: ses_abc123 | Model: claude-sonnet-4                 │
│ Context: 45% (89K/200K) | Cost: $0.12                        │
│                                                              │
│ [Abort]  [View Log]                                          │
└─────────────────────────────────────────────────────────────┘
```

**Behavior:**
- Max 20 entries shown (rolling window)
- New entries push old ones out
- `[in progress]` while tool running
- Updates to `→ result` when tool completes
- Each entry has `[view]` link to thread message
- Status line at bottom with live stats
- Spinner cycles: ◐ ◓ ◑ ◒

### 3.3 Activity Thread

Parallel to rolling window, detailed entries posted to thread:

```
User's message (@bot do something)
  └── :gear: Starting analysis...
  └── :thought_balloon: **Thinking** (2.3s)
      > First 500 chars of thinking content...
      > [truncated - click to expand]
  └── :mag: **Grep** "session" in *.ts
      > Found 47 matches across 12 files
      > slack/src/session/types.ts:15
      > slack/src/session/manager.ts:42
      > ...
  └── :pencil2: **Edit** codex/src/streaming.ts
      > -  if (streamingManager.isAnyStreaming()) {
      > +  if (tracker.isBusy(conversationKey)) {
  └── :white_check_mark: **Complete** (12.4s, 89K tokens, $0.12)
      > [Response posted above]
```

**Behavior:**
- Each activity entry gets its own thread message
- Updated in-place when tool completes (adds result)
- Thinking shows preview + "click to expand"
- Links back to main activity window
- Posted with rate limiting (min 2s gap)

---

## 4. Fork System

### 4.1 Fork Here Button

Appears on every assistant message in the activity rolling window:

```
┌─────────────────────────────────────────────────────────────┐
│ [response content...]                                        │
│                                                              │
│ Tokens: 1,234 in / 567 out | Cost: $0.02                    │
│                                                              │
│ [Fork Here]                                                  │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 Fork Flow

1. User clicks `[Fork Here]` on a message
2. Modal opens: "Fork to new channel?"
   - Shows channel name input (default: `fork-<original>-<timestamp>`)
   - Shows fork point info: "Forking from message #3 in conversation"
3. User confirms
4. System:
   - Creates new channel
   - Looks up `messageMap[slackTs]` → gets `ForkPoint`
   - Creates forked session with `forkPointId`
   - Agent creates forked backend session (SDK resumeSessionAt / Codex forkThreadAtTurn)
   - Posts welcome message: "Forked from #original-channel at [link to source message]"
5. User continues conversation from that point

### 4.3 Fork Interface (Agents Implement)

```typescript
// Each agent implements this
interface IForkable {
  /**
   * Find fork point for a Slack message timestamp.
   * Looks up in persisted messageMap.
   */
  findForkPoint(channelId: string, slackTs: string): ForkPoint | null;
  
  /**
   * Create a forked backend session at the given point.
   * Returns new session ID.
   * 
   * Claude: Uses SDK resumeSessionAt with message ID
   * Codex: Uses forkThreadAtTurn with turn index
   * OpenCode: TBD based on backend
   */
  createForkedSession(forkPoint: ForkPoint, workingDir: string): Promise<string>;
}
```

---

## 5. Commands

### 5.1 /status (Unified)

Combines ccslack `/status` + `/context` into single command:

```
┌─────────────────────────────────────────────────────────────┐
│ :information_source: Session Status                          │
├─────────────────────────────────────────────────────────────┤
│ Session ID: ses_abc123def456                                 │
│ Working Dir: /projects/alpha                                 │
│ Path Locked: Yes (by @user1 on Jan 15)                      │
│                                                              │
│ Model: claude-sonnet-4-20250514                             │
│ Mode: default                                                │
│                                                              │
│ Context Usage:                                               │
│ ████████████░░░░░░░░ 45% (89,234 / 200,000 tokens)          │
│                                                              │
│ Last Query:                                                  │
│   Input: 12,345 tokens (8,234 cached)                       │
│   Output: 2,456 tokens                                       │
│   Cost: $0.12                                                │
│                                                              │
│ Auto-compact at: 85% (~170K tokens)                         │
│ Tokens until compact: ~81K                                   │
├─────────────────────────────────────────────────────────────┤
│ [Clear Context] [Change Model] [Change Mode]                 │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 /resume <session-id>

Resume a different session in current channel:

```
@bot /resume ses_xyz789
```

**Behavior:**
1. Validate session-id format
2. Check if session file exists (for that agent)
3. If session has `configuredPath`:
   - Set `workingDir` to that path
   - Lock path if not already locked: `pathConfigured = true`
4. Update channel session to point to resumed session
5. Post confirmation:
   ```
   :arrows_counterclockwise: Resumed session ses_xyz789
   Working directory: /projects/beta (locked)
   Context: 23% (45K tokens)
   ```

### 5.3 Other Commands (Shared Interface)

| Command | Description | Shared? |
|---------|-------------|---------|
| `/clear` | Clear context, start fresh session | Yes |
| `/path <dir>` | Set working directory (first time only) | Yes |
| `/model` | Open model picker | Yes (UI), No (model list) |
| `/mode` or `/policy` | Open mode/policy picker | Agent-specific |
| `/update-rate <1-10>` | Set status update frequency | Yes |
| `/limit <100-36000>` | Set thread message char limit | Yes |
| `/help` | Show available commands | Yes (base) + agent-specific |

---

## 6. DM Notifications

### 6.1 Format

When query completes, send DM to user who initiated:

```
:white_check_mark: `Implement the session interface...` #project-alpha [View]
```

**Components:**
- Status icon: `:white_check_mark:` (success), `:x:` (error), `:stop_sign:` (aborted)
- Query preview: First ~50 chars of user's message in backticks
- Channel link: `#channel-name`
- View button: Links to the response message

### 6.2 DM Notification Interface

```typescript
// slack/src/notifications/dm-notifications.ts

interface DmNotification {
  userId: string;
  status: 'success' | 'error' | 'aborted';
  queryPreview: string;         // First ~50 chars
  channelId: string;
  channelName: string;
  messageTs: string;            // For permalink
  threadTs?: string;
}

async function sendCompletionDm(
  client: WebClient,
  notification: DmNotification
): Promise<void>;
```

---

## 7. Emoji Reactions

### 7.1 Processing Lifecycle

| State | Emoji | When |
|-------|-------|------|
| Processing started | :eyes: | Query received, starting |
| Waiting for approval | :raised_hand: | Tool needs approval |
| Complete (success) | :white_check_mark: | Response posted |
| Complete (error) | :x: | Error occurred |
| Aborted | :stop_sign: | User clicked Abort |

### 7.2 Emoji Interface

```typescript
// slack/src/ui/emoji-reactions.ts

async function markProcessingStart(client: WebClient, channel: string, ts: string): Promise<void>;
async function markApprovalWait(client: WebClient, channel: string, ts: string): Promise<void>;
async function markComplete(client: WebClient, channel: string, ts: string): Promise<void>;
async function markError(client: WebClient, channel: string, ts: string): Promise<void>;
async function markAborted(client: WebClient, channel: string, ts: string): Promise<void>;
async function removeProcessingEmoji(client: WebClient, channel: string, ts: string): Promise<void>;
```

---

## 8. Bot Isolation Model

### 8.1 Three Bots, One Workspace

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SLACK WORKSPACE "AcmeCorp"                           │
│                                                                              │
│  ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐    │
│  │ Claude Bot          │ │ Codex Bot           │ │ OpenCode Bot        │    │
│  │ @claude             │ │ @codex              │ │ @opencode           │    │
│  │                     │ │                     │ │                     │    │
│  │ ConversationTracker │ │ ConversationTracker │ │ ConversationTracker │    │
│  │ claude-sessions.json│ │ codex-sessions.json │ │ opencode-sessions.json│  │
│  └─────────────────────┘ └─────────────────────┘ └─────────────────────┘    │
│                                                                              │
│  Channels:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ #project-alpha                                                       │    │
│  │   - Claude session: ses_c1 (processing)                             │    │
│  │   - Codex session: thread_x1 (idle)                                 │    │
│  │   - OpenCode session: oc_a1 (idle)                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ #project-beta                                                        │    │
│  │   - Claude session: ses_c2 (idle)                                   │    │
│  │   - Codex session: thread_x2 (processing)                           │    │
│  │   - OpenCode session: none yet                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Isolation Rules

1. **Bot Isolation**: Each bot has completely independent state
   - Own session file
   - Own ConversationTracker
   - Can all process in parallel

2. **Session Isolation**: Within a bot, each channel/thread is independent
   - Different channels can process in parallel
   - Different threads in same channel can process in parallel

3. **Concurrent Query Blocking**: Same bot + same conversation = blocked
   - User sends query to @claude in #project-alpha
   - While processing, another query to @claude in #project-alpha → error
   - But query to @codex in #project-alpha → allowed (different bot)
   - And query to @claude in #project-beta → allowed (different channel)

### 8.3 Crash Recovery

**On crash:**
- In-memory `ConversationTracker` is lost
- Persisted sessions remain intact

**On restart:**
- `busyConversations` is empty (all conversations appear idle)
- Old "Processing..." messages in Slack are orphaned (cosmetic issue)
- User can immediately send new query
- Session context (history, fork points) is preserved

---

## 9. Implementation Phases

### Phase 1: Core Session Infrastructure (slack/)

1. Create `slack/src/session/` module:
   - `types.ts` - Base interfaces
   - `conversation-key.ts` - Key utilities (standardize on `_` separator)
   - `conversation-tracker.ts` - In-memory busy/context tracking
   - `base-session-manager.ts` - Abstract base with mutex persistence

2. Create `slack/src/activity/` module:
   - `types.ts` - ActivityEntry interface
   - `activity-manager.ts` - Rolling window logic

3. Create `slack/src/ui/` module:
   - `emoji-reactions.ts` - Shared emoji helpers

4. Create `slack/src/notifications/` module:
   - `dm-notifications.ts` - Completion DMs

### Phase 2: Migrate Codex to Shared Infrastructure

1. Update `codex/src/session-manager.ts`:
   - Extend `BaseSessionManager`
   - Change session file to `codex-sessions.json`
   - Add `messageMap` for fork tracking (migrate from `messageTurnMap`)
   - Standardize conversation key to `_` separator

2. Update `codex/src/slack-bot.ts`:
   - Replace `streamingManager.isAnyStreaming()` with `ConversationTracker.isBusy(key)`
   - Add proper busy state tracking per-conversation

3. Update `codex/src/streaming.ts`:
   - Use shared activity types
   - Integrate with shared activity manager

### Phase 3: Refactor Claude to Use Shared Infrastructure

1. Update `claude/src/session-manager.ts`:
   - Extend `BaseSessionManager`
   - Change session file to `claude-sessions.json`
   - Keep existing `messageMap` (already correct format)

2. Update `claude/src/slack-bot.ts`:
   - Replace local `busyConversations` with `ConversationTracker`
   - Use shared emoji reactions

3. Consolidate duplicate code:
   - Move common block builders to `slack/src/ui/`
   - Move common activity logic to `slack/src/activity/`

### Phase 4: Implement OpenCode

1. Create `opencode/src/session-manager.ts`:
   - Extend `BaseSessionManager`
   - Implement agent-specific session fields
   - Use `opencode-sessions.json`

2. Create `opencode/src/slack-bot.ts`:
   - Use all shared infrastructure from `slack/`
   - Implement OpenCode-specific backend integration

3. Create `opencode/src/opencode-client.ts`:
   - Backend communication
   - Implement fork mechanism

---

## 10. Testing Strategy

### Unit Tests

- `slack/src/session/` - Conversation key parsing, tracker operations
- `slack/src/activity/` - Rolling window logic, entry formatting
- Each agent's session manager extending base correctly

### Integration Tests

- Bot isolation: Three bots processing in same channel don't interfere
- Session isolation: Same bot in different channels process in parallel
- Busy blocking: Same bot same channel rejects concurrent query
- Fork flow: Fork Here creates correct point-in-time session
- Crash recovery: Restart with persisted sessions works correctly
- DM notifications: Completion sends correct DM

---

## 11. Open Questions

1. **OpenCode backend**: What's the session/thread model? Need to understand before implementing fork.

2. **Channel creation for forks**: Do we have bot permissions to create channels? May need to fork to existing channel or use different UX.

3. **Session cleanup**: When should old sessions be garbage collected? Add TTL? Manual `/delete-session`?

4. **Multi-workspace**: If we later support multiple Slack workspaces, session files need workspace prefix. Consider now or later?

---

## 12. Key Architectural Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Conversation key separator | `_` | URL-safe, no encoding needed |
| Session file per agent | Yes | Complete isolation, independent lifecycles |
| ConversationTracker | Per-agent instance | No shared state between bots |
| Fork point tracking | Required interface | Consistent behavior, agent-specific implementation |
| Busy state | In-memory only | Safe to lose on crash, no stale locks |
| Session data | Persisted to JSON | Must survive restart for continuity |
